---
alwaysApply: false
description: "Tailscale operator configuration patterns and requirements for Talos Linux with generic device plugin integration"

---

# Tailscale Operator on Talos Linux

## Overview
Tailscale operator requires special configuration when running on Talos Linux due to changes in how Talos handles the `/dev/net/tun` device from version 1.8.0 onwards.

## Key Requirements

### 1. Generic Device Plugin
- **Purpose**: Exposes `/dev/net/tun` device as Kubernetes resource `squat.ai/tun`
- **Location**: `kubernetes/apps/kube-system/generic-device-plugin/`
- **Pattern**: Use Flux Kustomization (`ks.yaml`) with proper namespace targeting

### 2. ProxyClass Configuration
- **File**: `kubernetes/apps/network/tailscale/proxyclass/proxyclass.yaml`
- **Structure**: Use `spec.statefulSet.pod.tailscaleContainer` (not `spec.pod`)
- **Security Context**: Must run as privileged with root access on Talos Linux

### 3. OAuth Secret Mounting
- **Method**: Use `oauthSecretVolume` instead of environment variables
- **Secret Structure**: Map `TAILSCALE_OAUTH_CLIENT_ID` → `client_id` and `TAILSCALE_OAUTH_CLIENT_SECRET` → `client_secret`

## Configuration Patterns

### Generic Device Plugin DaemonSet
```yaml
# Use ghcr.io/squat/generic-device-plugin:latest
# Include proper tolerations for control plane nodes
# Mount /dev/net/tun device with 1000 count
```

### ProxyClass for Talos Linux
```yaml
spec:
  statefulSet:
    pod:
      securityContext:
        runAsNonRoot: false
        runAsUser: 0
        fsGroup: 0
      tailscaleContainer:
        resources:
          limits:
            squat.ai/tun: "1"
        securityContext:
          privileged: true
          capabilities:
            add: ["NET_ADMIN", "NET_RAW", "SYS_ADMIN"]
```

### HelmRelease OAuth Configuration
```yaml
values:
  oauthSecretVolume:
    secret:
      secretName: tailscale-oauth-secret
      items:
        - key: TAILSCALE_OAUTH_CLIENT_ID
          path: client_id
        - key: TAILSCALE_OAUTH_CLIENT_SECRET
          path: client_secret
```

## File Organization
- **Generic Device Plugin**: `kubernetes/apps/kube-system/generic-device-plugin/`
- **Tailscale App**: `kubernetes/apps/network/tailscale/app/`
- **ProxyClass**: `kubernetes/apps/network/tailscale/proxyclass/`

## Common Issues
1. **Missing tun device**: Deploy generic device plugin first
2. **OAuth mount failures**: Use `oauthSecretVolume` not environment variables
3. **ProxyClass schema errors**: Use `spec.statefulSet.pod` structure
4. **Namespace conflicts**: Deploy device plugin in kube-system, apps in network
# Tailscale Operator on Talos Linux

## Overview
Tailscale operator requires special configuration when running on Talos Linux due to changes in how Talos handles the `/dev/net/tun` device from version 1.8.0 onwards.

## Key Requirements

### 1. Generic Device Plugin
- **Purpose**: Exposes `/dev/net/tun` device as Kubernetes resource `squat.ai/tun`
- **Location**: `kubernetes/apps/kube-system/generic-device-plugin/`
- **Pattern**: Use Flux Kustomization (`ks.yaml`) with proper namespace targeting

### 2. ProxyClass Configuration
- **File**: `kubernetes/apps/network/tailscale/proxyclass/proxyclass.yaml`
- **Structure**: Use `spec.statefulSet.pod.tailscaleContainer` (not `spec.pod`)
- **Security Context**: Must run as privileged with root access on Talos Linux

### 3. OAuth Secret Mounting
- **Method**: Use `oauthSecretVolume` instead of environment variables
- **Secret Structure**: Map `TAILSCALE_OAUTH_CLIENT_ID` → `client_id` and `TAILSCALE_OAUTH_CLIENT_SECRET` → `client_secret`

## Configuration Patterns

### Generic Device Plugin DaemonSet
```yaml
# Use ghcr.io/squat/generic-device-plugin:latest
# Include proper tolerations for control plane nodes
# Mount /dev/net/tun device with 1000 count
```

### ProxyClass for Talos Linux
```yaml
spec:
  statefulSet:
    pod:
      securityContext:
        runAsNonRoot: false
        runAsUser: 0
        fsGroup: 0
      tailscaleContainer:
        resources:
          limits:
            squat.ai/tun: "1"
        securityContext:
          privileged: true
          capabilities:
            add: ["NET_ADMIN", "NET_RAW", "SYS_ADMIN"]
```

### HelmRelease OAuth Configuration
```yaml
values:
  oauthSecretVolume:
    secret:
      secretName: tailscale-oauth-secret
      items:
        - key: TAILSCALE_OAUTH_CLIENT_ID
          path: client_id
        - key: TAILSCALE_OAUTH_CLIENT_SECRET
          path: client_secret
```

## File Organization
- **Generic Device Plugin**: `kubernetes/apps/kube-system/generic-device-plugin/`
- **Tailscale App**: `kubernetes/apps/network/tailscale/app/`
- **ProxyClass**: `kubernetes/apps/network/tailscale/proxyclass/`

## Common Issues
1. **Missing tun device**: Deploy generic device plugin first
2. **OAuth mount failures**: Use `oauthSecretVolume` not environment variables
3. **ProxyClass schema errors**: Use `spec.statefulSet.pod` structure
4. **Namespace conflicts**: Deploy device plugin in kube-system, apps in network
